# 📦 DZPoker - 部署文件使用说明

## 📁 新增部署文件清单

为了方便您在 Amazon Linux 服务器上部署，我为您创建了以下文件：

### 🔧 部署脚本

| 文件名 | 大小 | 说明 |
|--------|------|------|
| **deploy-amazon-linux.sh** | 16KB | 🌟 全自动部署脚本，首次部署使用 |
| **quick-deploy.sh** | 4.2KB | ⚡ 快速部署脚本，适合已安装Docker的环境 |

### 📋 配置文件

| 文件名 | 大小 | 说明 |
|--------|------|------|
| **docker-compose.prod.yml** | 2.6KB | 生产环境Docker Compose配置 |
| **nginx/nginx.conf** | ~4KB | Nginx反向代理配置文件 |
| **.dockerignore** | ~1KB | Docker构建忽略文件 |

### 📖 文档文件

| 文件名 | 大小 | 说明 |
|--------|------|------|
| **QUICK-START.md** | 7.2KB | ⭐ 快速开始指南 (推荐首先阅读) |
| **README-DEPLOYMENT.md** | 8.1KB | 详细部署指南和故障排查 |
| **DEPLOYMENT-CHECKLIST.md** | 8.8KB | 部署检查清单 |
| **部署文件使用说明.md** | 本文件 | 文件说明和使用指南 |

---

## 🚀 快速上手 (3步搞定)

### 方案A: 一键自动部署 (最简单)

```bash
# 步骤1: 上传部署脚本到服务器
scp -i your-key.pem deploy-amazon-linux.sh ec2-user@YOUR_IP:/home/ec2-user/

# 步骤2: SSH连接服务器
ssh -i your-key.pem ec2-user@YOUR_IP

# 步骤3: 执行部署脚本
chmod +x deploy-amazon-linux.sh
sudo bash deploy-amazon-linux.sh
```

脚本会自动完成所有配置，10-15分钟后即可访问！

---

### 方案B: 快速部署 (推荐熟手)

```bash
# 步骤1: 上传整个项目
scp -i your-key.pem -r dzpoker/ ec2-user@YOUR_IP:/opt/

# 步骤2: SSH连接服务器
ssh -i your-key.pem ec2-user@YOUR_IP

# 步骤3: 执行快速部署
cd /opt/dzpoker
chmod +x quick-deploy.sh
bash quick-deploy.sh
```

3-5分钟即可完成！

---

## 📚 文档阅读顺序

### 新手推荐阅读顺序：

1. **QUICK-START.md** - 快速了解部署流程 (5分钟)
2. **DEPLOYMENT-CHECKLIST.md** - 按清单逐步部署 (边看边做)
3. **README-DEPLOYMENT.md** - 遇到问题时查阅 (故障排查)

### 老手推荐阅读顺序：

1. **QUICK-START.md** - 快速浏览 (2分钟)
2. 直接执行部署脚本
3. 遇到问题查阅 **README-DEPLOYMENT.md**

---

## 🛠️ 部署脚本详解

### deploy-amazon-linux.sh (全自动部署)

**功能特性:**
- ✅ 自动检测系统版本 (Amazon Linux 2/2023)
- ✅ 自动安装Docker和Docker Compose
- ✅ 自动配置防火墙规则
- ✅ 自动生成安全密钥
- ✅ 支持从Git克隆或手动上传代码
- ✅ 可选安装Nginx反向代理
- ✅ 可选创建系统服务
- ✅ 自动健康检查
- ✅ 显示访问地址和常用命令

**使用场景:**
- 全新的Amazon Linux服务器
- 第一次部署此项目
- 不想手动安装各种依赖

**执行时间:** 约10-15分钟

**使用方法:**
```bash
sudo bash deploy-amazon-linux.sh
```

**交互式提示:**
脚本运行时会询问您:
1. 项目部署目录 (默认: /opt/dzpoker)
2. 代码获取方式 (Git/手动上传/跳过)
3. 是否安装Nginx (推荐: y)
4. 是否创建系统服务 (推荐: y)

---

### quick-deploy.sh (快速部署)

**功能特性:**
- ⚡ 快速启动，无需安装依赖
- ⚡ 自动生成环境配置
- ⚡ 自动构建和启动服务
- ⚡ 自动健康检查

**使用场景:**
- Docker已经安装好
- 代码已经上传到服务器
- 需要快速重新部署

**执行时间:** 约3-5分钟

**使用方法:**
```bash
bash quick-deploy.sh
```

**无需交互:** 脚本自动完成所有操作

---

## ⚙️ 配置文件说明

### docker-compose.prod.yml

**用途:** 生产环境的Docker Compose配置

**与开发版区别:**
- 使用Gunicorn多进程运行 (4 workers)
- 禁用DEBUG模式
- 数据库和Redis只监听本地 (127.0.0.1)
- 配置健康检查
- 配置日志轮转
- 优化资源限制

**使用方法:**
```bash
docker-compose -f docker-compose.prod.yml up -d
```

---

### nginx/nginx.conf

**用途:** Nginx反向代理配置

**功能:**
- HTTP/HTTPS反向代理
- WebSocket支持
- 静态资源缓存
- Gzip压缩
- 安全头配置

**使用方法:**
1. 安装Nginx: `sudo yum install -y nginx`
2. 复制配置: `sudo cp nginx/nginx.conf /etc/nginx/nginx.conf`
3. 测试配置: `sudo nginx -t`
4. 重启Nginx: `sudo systemctl restart nginx`

---

## 🔐 安全配置建议

### 1. 首次部署后立即执行

```bash
# 修改数据库密码
docker-compose exec db psql -U postgres -c "ALTER USER postgres PASSWORD 'YOUR_STRONG_PASSWORD';"

# 更新配置文件
vim backend/.env
# 修改 DATABASE_URL 中的密码

# 重启服务
docker-compose restart api
```

### 2. 配置HTTPS (强烈推荐)

```bash
# 安装certbot
sudo yum install -y certbot python3-certbot-nginx

# 获取免费SSL证书
sudo certbot --nginx -d your-domain.com

# 设置自动续期
sudo crontab -e
# 添加: 0 0 * * * certbot renew --quiet
```

### 3. 限制端口访问

**使用Nginx后，关闭直接端口访问:**
```bash
sudo firewall-cmd --permanent --remove-port=3000/tcp
sudo firewall-cmd --permanent --remove-port=8000/tcp
sudo firewall-cmd --reload
```

只保留80和443端口对外开放。

---

## 📊 部署后验证

### 快速检查

```bash
# 查看服务状态
cd /opt/dzpoker
docker-compose ps

# 应该看到:
# poker-api        Up (healthy)
# poker-frontend   Up
# poker-db         Up (healthy)
# poker-redis      Up
```

### 访问测试

在浏览器中访问:
- **前端**: http://YOUR_IP:3000
- **API文档**: http://YOUR_IP:8000/docs

### 功能测试

- [ ] 注册新用户
- [ ] 登录系统
- [ ] 创建游戏
- [ ] 测试发牌功能

---

## 🐛 常见问题解决

### Q1: 脚本执行权限不足

**问题:** `Permission denied`

**解决:**
```bash
chmod +x deploy-amazon-linux.sh
chmod +x quick-deploy.sh
```

---

### Q2: Docker命令找不到

**问题:** `docker: command not found`

**解决:**
```bash
# 使用完整部署脚本
sudo bash deploy-amazon-linux.sh
```

---

### Q3: 端口无法访问

**问题:** 浏览器无法访问3000或8000端口

**解决:**
1. 检查AWS安全组规则
2. 检查防火墙: `sudo firewall-cmd --list-all`
3. 检查服务状态: `docker-compose ps`

---

### Q4: 容器启动失败

**问题:** 容器状态为 `Exit 1` 或 `Restarting`

**解决:**
```bash
# 查看日志
docker-compose logs api
docker-compose logs frontend

# 重新构建
docker-compose build --no-cache
docker-compose up -d
```

---

## 📞 获取更多帮助

### 查看详细日志

```bash
# 实时查看所有日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f api

# 查看最近100行日志
docker-compose logs --tail=100 api
```

### 进入容器调试

```bash
# 进入API容器
docker-compose exec api bash

# 进入数据库
docker-compose exec db psql -U postgres -d poker

# 进入Redis
docker-compose exec redis redis-cli
```

---

## 🔄 日常维护命令

```bash
# 重启服务
docker-compose restart

# 查看资源使用
docker stats

# 备份数据库
docker-compose exec db pg_dump -U postgres poker > backup_$(date +%Y%m%d).sql

# 清理Docker资源
docker system prune -a

# 更新代码并重启
git pull
docker-compose build
docker-compose up -d
```

---

## 📈 性能监控

### 查看系统资源

```bash
# CPU和内存
htop

# 磁盘使用
df -h

# Docker容器资源
docker stats
```

### 数据库性能

```bash
# 查看数据库大小
docker-compose exec db psql -U postgres -c "SELECT pg_size_pretty(pg_database_size('poker'));"

# 查看连接数
docker-compose exec db psql -U postgres -c "SELECT count(*) FROM pg_stat_activity;"
```

---

## 📝 重要提醒

### ⚠️ 部署前必看

1. **备份数据**: 如果是更新部署，先备份数据库
2. **修改密码**: 部署后立即修改默认密码
3. **配置HTTPS**: 生产环境务必配置SSL证书
4. **安全组设置**: 确保AWS安全组规则正确
5. **定期备份**: 设置定时任务自动备份数据

### ✅ 部署成功标志

- [ ] 所有Docker容器状态为 `Up`
- [ ] 前端页面可以正常打开
- [ ] API文档可以正常访问
- [ ] 用户可以注册和登录
- [ ] 游戏功能正常运行

---

## 🎯 下一步操作

### 基础配置 (必做)

1. ✅ 修改数据库密码
2. ✅ 修改JWT密钥
3. ✅ 配置定期备份

### 进阶配置 (推荐)

1. 🔒 配置HTTPS证书
2. 🌐 配置域名解析
3. 📊 配置监控告警
4. 🚀 性能优化调整

### 可选配置

1. 配置Nginx反向代理
2. 配置CDN加速
3. 配置Redis持久化
4. 配置数据库主从复制

---

## 📚 相关文档链接

- [系统架构设计](系统架构设计.md)
- [技术栈说明](技术栈与开发路线图.md)
- [需求说明书](需求说明书.md)
- [原始README](README.md)

---

## 🎉 总结

您现在拥有完整的部署工具包:

- ✅ 2个自动化部署脚本
- ✅ 生产环境配置文件
- ✅ Nginx反向代理配置
- ✅ 3份详细文档

**推荐部署流程:**

1. 阅读 `QUICK-START.md` (5分钟)
2. 执行 `deploy-amazon-linux.sh` (10分钟)
3. 验证部署成功
4. 按照安全建议加固系统

**总耗时:** 约20-30分钟即可完成生产环境部署！

---

**祝您部署顺利！** 🚀

有任何问题，请参考 `README-DEPLOYMENT.md` 中的故障排查部分。
